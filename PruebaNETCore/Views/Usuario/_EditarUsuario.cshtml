@model ProyectoSolveCore.Models.ViewModels.vmUsuarioConductorRoles
<div class="modal-dialog modal-lg">
    <div class="modal-content fw-bold">
        <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Editar usuario</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="form_EditarUsuario">
            <div class="modal-body row fw-bold">
                <div class="col col-lg-12">
                    <div class="row g-2">
                        <input type="hidden" asp-for="ID" />
                        <input type="hidden" asp-for="eliminado" />
                        <input type="hidden" asp-for="direccion_img" />
                        <input id="idDepartamento" type="hidden" asp-for="id_departamento" />
                        <input id="RolAdministrador" type="hidden" asp-for="RolAdministrador" />
                        <input id="RolJefe" type="hidden" asp-for="RolJefe" />
                        <input id="RolMantendorUsuarios" type="hidden" asp-for="RolMantendorUsuarios" />
                        <input id="RolMantenedorVehiculos" type="hidden" asp-for="RolMantenedorVehiculos" />
                        <input id="RolSolicitador" type="hidden" asp-for="RolSolicitador" />
                        <input type="hidden" asp-for="id_conductor" />
                        <div class="col-md-4">
                            <label for="inputRut" class="form-label">RUT</label>
                            <input type="text" class="form-control" name="rut" id="inputRut"
                                   placeholder="Con guión y sin puntos" value="@Model.rut" required>
                        </div>
                        <div class="col-md-4">
                            <label for="inputClave" class="form-label">Nueva clave de acceso</label>
                            <input type="password" name="clave" class="form-control" id="inputClave"
                                   placeholder="Minimo 6 caracteres">
                        </div>
                        <div class="col-md-4">
                            <label for="inputClave" class="form-label">Reingrese la nueva clave</label>
                            <input type="password" class="form-control" name="reclave" id="inputReClave"
                                   placeholder="Minimo 6 caracteres">
                        </div>
                        <div class="col-md-6">
                            <label for="inputNombre" class="form-label">Nombre</label>
                            <input type="text" name="nombre" class="form-control" id="inputNombre"
                                   value="@Model.nombre" required>
                        </div>
                        <div class="col-md-6">
                            <label for="inputApellido" class="form-label">Apellido</label>
                            <input type="text" name="apellido" class="form-control" id="inputApellido"
                                   value="@Model.apellido" required>
                        </div>
                        <div class="col col-md-6">
                            <label for="inputDepartamento" class="form-label">Departamento</label>
                            <select class="form-select" asp-for="id_departamento" asp-items="ViewBag.id_departamento">
                            </select>
                        </div>
                        <div class="col col-md-6">
                            @*<label for="formFile" class="form-label">Subir imagen</label>
                            <input class="form-control" type="file" id="formFile">*@
                        </div>
                        <div class="col col-md-12">
                            <p class="mt-3 mb-2">Roles</p>
                            @*Administrador*@
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="Administrador" @(Model.RolAdministrador?"checked":"")>
                                <label class="form-check-label" for="Administrador">
                                    Administrador
                                </label>
                            </div>
                            @*Jefe*@
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="Jefe" @(Model.RolJefe?"checked":"")>
                                <label class="form-check-label" for="Jefe">
                                    Jefe
                                </label>
                            </div>
                            @*Mant. Usuarios*@
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="Usuarios" @(Model.RolMantendorUsuarios?"checked":"")>
                                <label class="form-check-label" for="Usuarios">
                                    Mantenedor Usuarios
                                </label>
                            </div>
                            @*Mant. Vehiculos*@
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="Vehiculos" @(Model.RolMantenedorVehiculos?"checked":"")>
                                <label class="form-check-label" for="Vehiculo">
                                    Mantenedor Vehículos
                                </label>
                            </div>
                            @*Solicitador*@
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="Solicitador" @(Model.RolSolicitador?"checked":"")>
                                <label class="form-check-label" for="Solicitador">
                                    Solicitador
                                </label>
                            </div>
                        </div>
                        <div class="mt-4 col-12 mb-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" 
                                    id="check_poliza" @(Model.NumeroPoliza != null?"checked":"")>
                                <label class="form-check-label" for="check_poliza">
                                    Tiene poliza de conductor
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="row g-2" id="conductor" style="display: none;">
                        <div class="col-md-12">
                            <label for="inputNumPoliza" class="form-label">Numero de poliza</label>
                            <input type="text" class="form-control" id="inputNumPoliza" name="NumeroPoliza"
                                   value="@Model.NumeroPoliza">
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Periodo de la poliza</label>
                            <div class="input-group">
                                <span class="input-group-text" id="inputGroup-sizing-default">Fecha emitida</span>
                                <input type="date" class="form-control" id="inputFechaInicio" value="@Model.FechaEmitida?.ToString("yyyy-MM-dd")"
                                       aria-label="Sizing example input" aria-describedby="inputFechaInicio" name="FechaEmitida">
                            </div>
                            <div class="input-group">
                                <span class="input-group-text" id="inputGroup-sizing-default">Fecha vencimiento</span>
                                <input type="date" class="form-control" id="inputFechaFin" value="@Model.FecheVencimiento?.ToString("yyyy-MM-dd")"
                                       aria-label="Sizing example input" aria-describedby="inputFechaFin" name="FecheVencimiento">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-warning">
                    <i class="fa-sharp fa-pen"></i>
                    Editar usuario
                </button>
            </div>
        </form>
    </div>
</div>
<script type="text/javascript">
    var contenedores_conductores = document.querySelector("#conductor");
    var admin = document.querySelector("#Administrador");
    var jefe = document.querySelector("#Jefe");
    var vehiculos = document.querySelector("#Vehiculos");
    var usuarios = document.querySelector("#Usuarios");
    var solicitador = document.querySelector("#Solicitador");
    var inputs = contenedores_conductores.getElementsByTagName('input');

    var rolAdmin = document.querySelector("#RolAdministrador");
    var rolJefe = document.querySelector("#RolJefe");
    var rolMantenedorUsuarios = document.querySelector("#RolMantendorUsuarios");
    var rolMantenedorVehiculos = document.querySelector("#RolMantenedorVehiculos");
    var rolSolicitador = document.querySelector("#RolSolicitador");

    $('#form_EditarUsuario').submit(function (e) {
        e.preventDefault();
        var params = new URLSearchParams($(this).serialize());

        var objeto = {};
        for (var pair of params.entries()) {
            var key = pair[0];
            var value = pair[1];
            objeto[key] = value
        }

        if (jefe.checked || vehiculos.checked || 
            usuarios.checked || solicitador.checked || admin.checked) {
            if (objeto.clave !== objeto.reclave) {
                console.log("error");
                return;
            }
            //Elimino el atributo para verificar el estatus de la clave
            delete objeto.reclave;

            if (!check_poliza.checked){
                objeto.FechaEmitida = null;
                objeto.FecheVencimiento = null;
                objeto.NumeroPoliza = null;
            }

            $.ajax({
                url: '/Usuario/EditarUsuario',
                type: 'POST',
                data: objeto,
                success: function (result) {
                    location = location.href;
                },
                error: function (xhr, error) {
                    console.log(error);
                }
            });
        }       
        
    });

    if (check_poliza.checked) {
        contenedores_conductores.style.display = "block";
        for (var i = 0; i < inputs.length; i++) {
            inputs[i].setAttribute('required', '');
        }
    }

    admin.addEventListener("click", function () {
        jefe.checked = admin.checked;
        vehiculos.checked = admin.checked;
        usuarios.checked = admin.checked;
        solicitador.checked = admin.checked;
        updateInputs();
    });

    jefe.addEventListener("change", updateInputs);
    vehiculos.addEventListener("change", updateInputs);
    usuarios.addEventListener("change", updateInputs);
    solicitador.addEventListener("change", updateInputs);

    function updateInputs() {
        if (jefe.checked && vehiculos.checked && usuarios.checked && solicitador.checked) {
            admin.checked = true;
        } else {
            admin.checked = false;
        }
        rolAdmin.value = admin.checked;
        rolJefe.value = jefe.checked;
        rolMantenedorVehiculos.value = vehiculos.checked;
        rolMantenedorUsuarios.value = usuarios.checked;
        rolSolicitador.value = solicitador.checked;
    }

    //Verificar si el check de la poliza esta activado
    check_poliza.addEventListener('change', () => {
        if (check_poliza.checked) {
            contenedores_conductores.style.display = "block";
            for (var i = 0; i < inputs.length; i++) {
                inputs[i].setAttribute('required', '');
            }
        } else {
            for (var i = 0; i < inputs.length; i++) {
                inputs[i].removeAttribute('required');
            }
            contenedores_conductores.style.display = "none";
        }
    });

    var dropDown = document.getElementById('id_departamento');

    dropDown.addEventListener('change', () => {
        const opcionSeleccionada = dropDown.value;
        document.getElementById('idDepartamento').value = opcionSeleccionada;
    });
</script>